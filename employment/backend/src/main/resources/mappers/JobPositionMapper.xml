<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gr.geias.repository.JobPositionRepository">
    
    <!-- 岗位结果映射 -->
    <resultMap id="jobPositionResultMap" type="com.gr.geias.model.JobPosition">
        <id property="jobId" column="job_id"/>
        <result property="companyId" column="company_id"/>
        <result property="title" column="title"/>
        <result property="description" column="description"/>
        <result property="requirements" column="requirements"/>
        <result property="salaryRange" column="salary_range"/>
        <result property="location" column="location"/>
        <result property="status" column="status"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <!-- 关联企业信息 -->
        <association property="companyInfo" javaType="com.gr.geias.model.CompanyInfo">
            <id property="companyId" column="c_company_id"/>
            <result property="companyName" column="c_company_name"/>
            <result property="companyIntro" column="c_company_intro"/>
            <result property="address" column="c_address"/>
            <result property="areaId" column="c_area_id"/>
        </association>
    </resultMap>
    
    <!-- 保存岗位信息 -->
    <insert id="saveJobPosition" parameterType="com.gr.geias.model.JobPosition" useGeneratedKeys="true" keyProperty="jobId">
        INSERT INTO tb_job_position(company_id, title, description, requirements, salary_range, location, status, create_time, update_time)
        VALUES(#{companyId}, #{title}, #{description}, #{requirements}, #{salaryRange}, #{location}, #{status}, NOW(), NOW())
    </insert>
    
    <!-- 更新岗位信息 -->
    <update id="updateJobPosition" parameterType="com.gr.geias.model.JobPosition">
        UPDATE tb_job_position
        SET title = #{title},
            description = #{description},
            requirements = #{requirements},
            salary_range = #{salaryRange},
            location = #{location},
            status = #{status},
            update_time = NOW()
        WHERE job_id = #{jobId} AND company_id = #{companyId}
    </update>
    
    <!-- 删除岗位 -->
    <delete id="deleteJobPosition">
        DELETE FROM tb_job_position WHERE job_id = #{jobId} AND company_id = #{companyId}
    </delete>
    
    <!-- 根据ID查询岗位 -->
    <select id="findJobPositionById" parameterType="java.lang.Integer" resultMap="jobPositionResultMap">
        SELECT j.*, 
               c.company_id as c_company_id, 
               c.company_name as c_company_name, 
               c.company_intro as c_company_intro, 
               c.address as c_address, 
               c.area_id as c_area_id
        FROM tb_job_position j
        LEFT JOIN tb_company_info c ON j.company_id = c.company_id
        WHERE j.job_id = #{jobId}
    </select>
    
    <!-- 查询企业的所有岗位 -->
    <select id="findJobPositionsByCompanyId" parameterType="java.lang.Integer" resultMap="jobPositionResultMap">
        SELECT j.*, 
               c.company_id as c_company_id, 
               c.company_name as c_company_name, 
               c.company_intro as c_company_intro, 
               c.address as c_address, 
               c.area_id as c_area_id
        FROM tb_job_position j
        LEFT JOIN tb_company_info c ON j.company_id = c.company_id
        WHERE j.company_id = #{companyId}
        ORDER BY j.update_time DESC
    </select>
    
    <!-- 分页查询所有发布状态的岗位 -->
    <select id="findPublishedJobPositions" resultMap="jobPositionResultMap">
        SELECT j.*, 
               c.company_id as c_company_id, 
               c.company_name as c_company_name, 
               c.company_intro as c_company_intro, 
               c.address as c_address, 
               c.area_id as c_area_id
        FROM tb_job_position j
        LEFT JOIN tb_company_info c ON j.company_id = c.company_id
        WHERE j.status = 1
        ORDER BY j.update_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 统计发布状态的岗位数量 -->
    <select id="countPublishedJobPositions" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM tb_job_position WHERE status = 1
    </select>
    
    <!-- 根据关键词搜索岗位 -->
    <select id="searchJobPositions" resultMap="jobPositionResultMap">
        SELECT j.*, 
               c.company_id as c_company_id, 
               c.company_name as c_company_name, 
               c.company_intro as c_company_intro, 
               c.address as c_address, 
               c.area_id as c_area_id
        FROM tb_job_position j
        LEFT JOIN tb_company_info c ON j.company_id = c.company_id
        WHERE j.status = 1
          AND (j.title LIKE CONCAT('%', #{keyword}, '%') OR j.description LIKE CONCAT('%', #{keyword}, '%'))
        ORDER BY j.update_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 统计搜索结果数量 -->
    <select id="countSearchJobPositions" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM tb_job_position 
        WHERE status = 1
          AND (title LIKE CONCAT('%', #{keyword}, '%') OR description LIKE CONCAT('%', #{keyword}, '%'))
    </select>
    
    <!-- 更新岗位状态 -->
    <update id="updateJobPositionStatus">
        UPDATE tb_job_position 
        SET status = #{status}, 
            update_time = NOW()
        WHERE job_id = #{jobId} AND company_id = #{companyId}
    </update>
</mapper> 