<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gr.geias.repository.ResumeDeliveryRepository">
    
    <!-- 简历投递结果映射 -->
    <resultMap id="resumeDeliveryResultMap" type="com.gr.geias.model.ResumeDelivery">
        <id property="deliveryId" column="delivery_id"/>
        <result property="resumeId" column="resume_id"/>
        <result property="jobId" column="job_id"/>
        <result property="companyId" column="company_id"/>
        <result property="status" column="status"/>
        <result property="deliveryTime" column="delivery_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="feedback" column="feedback"/>
        
        <!-- 关联简历信息 -->
        <association property="resume" javaType="com.gr.geias.model.Resume">
            <id property="resumeId" column="r_resume_id"/>
            <result property="userId" column="r_user_id"/>
            <result property="resumeName" column="r_resume_name"/>
            <result property="isDefault" column="r_is_default"/>
            <result property="status" column="r_status"/>
        </association>
        
        <!-- 关联岗位信息 -->
        <association property="jobPosition" javaType="com.gr.geias.model.JobPosition">
            <id property="jobId" column="j_job_id"/>
            <result property="companyId" column="j_company_id"/>
            <result property="title" column="j_title"/>
            <result property="salaryRange" column="j_salary_range"/>
            <result property="location" column="j_location"/>
        </association>
        
        <!-- 关联企业信息 -->
        <association property="companyInfo" javaType="com.gr.geias.model.CompanyInfo">
            <id property="companyId" column="c_company_id"/>
            <result property="companyName" column="c_company_name"/>
        </association>
    </resultMap>
    
    <!-- 保存简历投递记录 -->
    <insert id="saveResumeDelivery" parameterType="com.gr.geias.model.ResumeDelivery" useGeneratedKeys="true" keyProperty="deliveryId">
        INSERT INTO tb_resume_delivery(resume_id, job_id, company_id, status, delivery_time, update_time)
        VALUES(#{resumeId}, #{jobId}, #{companyId}, #{status}, NOW(), NOW())
    </insert>
    
    <!-- 更新简历投递状态 -->
    <update id="updateResumeDeliveryStatus" parameterType="com.gr.geias.model.ResumeDelivery">
        UPDATE tb_resume_delivery
        SET status = #{status},
            feedback = #{feedback},
            update_time = NOW()
        WHERE delivery_id = #{deliveryId}
    </update>
    
    <!-- 根据ID查询投递记录 -->
    <select id="findResumeDeliveryById" parameterType="java.lang.Integer" resultMap="resumeDeliveryResultMap">
        SELECT rd.*,
               r.resume_id as r_resume_id,
               r.user_id as r_user_id,
               r.resume_name as r_resume_name,
               r.is_default as r_is_default,
               r.status as r_status,
               j.job_id as j_job_id,
               j.company_id as j_company_id,
               j.title as j_title,
               j.salary_range as j_salary_range,
               j.location as j_location,
               c.company_id as c_company_id,
               c.company_name as c_company_name
        FROM tb_resume_delivery rd
        LEFT JOIN tb_resume r ON rd.resume_id = r.resume_id
        LEFT JOIN tb_job_position j ON rd.job_id = j.job_id
        LEFT JOIN tb_company_info c ON rd.company_id = c.company_id
        WHERE rd.delivery_id = #{deliveryId}
    </select>
    
    <!-- 根据简历ID和岗位ID查询投递记录 -->
    <select id="findResumeDeliveryByResumeAndJob" resultMap="resumeDeliveryResultMap">
        SELECT * FROM tb_resume_delivery
        WHERE resume_id = #{resumeId} AND job_id = #{jobId}
    </select>
    
    <!-- 查询简历的所有投递记录 -->
    <select id="findResumeDeliveriesByResumeId" parameterType="java.lang.Integer" resultMap="resumeDeliveryResultMap">
        SELECT rd.*,
               j.job_id as j_job_id,
               j.company_id as j_company_id,
               j.title as j_title,
               j.salary_range as j_salary_range,
               j.location as j_location,
               c.company_id as c_company_id,
               c.company_name as c_company_name
        FROM tb_resume_delivery rd
        LEFT JOIN tb_job_position j ON rd.job_id = j.job_id
        LEFT JOIN tb_company_info c ON rd.company_id = c.company_id
        WHERE rd.resume_id = #{resumeId}
        ORDER BY rd.delivery_time DESC
    </select>
    
    <!-- 查询用户的所有投递记录 -->
    <select id="findResumeDeliveriesByUserId" parameterType="java.lang.Long" resultMap="resumeDeliveryResultMap">
        SELECT rd.*,
               r.resume_id as r_resume_id,
               r.user_id as r_user_id,
               r.resume_name as r_resume_name,
               r.is_default as r_is_default,
               r.status as r_status,
               j.job_id as j_job_id,
               j.company_id as j_company_id,
               j.title as j_title,
               j.salary_range as j_salary_range,
               j.location as j_location,
               c.company_id as c_company_id,
               c.company_name as c_company_name
        FROM tb_resume_delivery rd
        JOIN tb_resume r ON rd.resume_id = r.resume_id
        LEFT JOIN tb_job_position j ON rd.job_id = j.job_id
        LEFT JOIN tb_company_info c ON rd.company_id = c.company_id
        WHERE r.user_id = #{userId}
        ORDER BY rd.delivery_time DESC
    </select>
    
    <!-- 查询岗位的所有投递记录 -->
    <select id="findResumeDeliveriesByJobId" parameterType="java.lang.Integer" resultMap="resumeDeliveryResultMap">
        SELECT rd.*,
               r.resume_id as r_resume_id,
               r.user_id as r_user_id,
               r.resume_name as r_resume_name,
               r.is_default as r_is_default,
               r.status as r_status
        FROM tb_resume_delivery rd
        LEFT JOIN tb_resume r ON rd.resume_id = r.resume_id
        WHERE rd.job_id = #{jobId}
        ORDER BY rd.delivery_time DESC
    </select>
    
    <!-- 查询企业的所有投递记录 -->
    <select id="findResumeDeliveriesByCompanyId" parameterType="java.lang.Integer" resultMap="resumeDeliveryResultMap">
        SELECT rd.*,
               r.resume_id as r_resume_id,
               r.user_id as r_user_id,
               r.resume_name as r_resume_name,
               r.is_default as r_is_default,
               r.status as r_status,
               j.job_id as j_job_id,
               j.company_id as j_company_id,
               j.title as j_title,
               j.salary_range as j_salary_range,
               j.location as j_location
        FROM tb_resume_delivery rd
        LEFT JOIN tb_resume r ON rd.resume_id = r.resume_id
        LEFT JOIN tb_job_position j ON rd.job_id = j.job_id
        WHERE rd.company_id = #{companyId}
        ORDER BY rd.delivery_time DESC
    </select>
    
    <!-- 统计岗位的投递数量 -->
    <select id="countResumeDeliveriesByJobId" parameterType="java.lang.Integer" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM tb_resume_delivery WHERE job_id = #{jobId}
    </select>
    
    <!-- 统计企业的投递数量 -->
    <select id="countResumeDeliveriesByCompanyId" parameterType="java.lang.Integer" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM tb_resume_delivery WHERE company_id = #{companyId}
    </select>
    
    <!-- 统计用户的投递数量 -->
    <select id="countResumeDeliveriesByUserId" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM tb_resume_delivery rd
        JOIN tb_resume r ON rd.resume_id = r.resume_id
        WHERE r.user_id = #{userId}
    </select>
</mapper> 