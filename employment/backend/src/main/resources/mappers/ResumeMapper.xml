<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gr.geias.repository.ResumeRepository">
    
    <!-- 简历结果映射 -->
    <resultMap id="resumeResultMap" type="com.gr.geias.model.Resume">
        <id property="resumeId" column="resume_id"/>
        <result property="userId" column="user_id"/>
        <result property="resumeName" column="resume_name"/>
        <result property="isDefault" column="is_default"/>
        <result property="status" column="status"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>
    
    <!-- 简历详情结果映射 -->
    <resultMap id="resumeDetailResultMap" type="com.gr.geias.model.ResumeDetail">
        <id property="detailId" column="detail_id"/>
        <result property="resumeId" column="resume_id"/>
        <result property="basicInfo" column="basic_info"/>
        <result property="education" column="education"/>
        <result property="workExperience" column="work_experience"/>
        <result property="projectExperience" column="project_experience"/>
        <result property="skills" column="skills"/>
        <result property="certificates" column="certificates"/>
        <result property="selfEvaluation" column="self_evaluation"/>
        <result property="attachmentUrl" column="attachment_url"/>
    </resultMap>
    
    <!-- 保存简历基本信息 -->
    <insert id="saveResume" parameterType="com.gr.geias.model.Resume" useGeneratedKeys="true" keyProperty="resumeId">
        INSERT INTO tb_resume(user_id, resume_name, is_default, status, create_time, update_time)
        VALUES(#{userId}, #{resumeName}, #{isDefault}, #{status}, NOW(), NOW())
    </insert>
    
    <!-- 更新简历基本信息 -->
    <update id="updateResume" parameterType="com.gr.geias.model.Resume">
        UPDATE tb_resume
        SET resume_name = #{resumeName},
            is_default = #{isDefault},
            status = #{status},
            update_time = NOW()
        WHERE resume_id = #{resumeId}
    </update>
    
    <!-- 删除简历 -->
    <delete id="deleteResume" parameterType="java.lang.Integer">
        DELETE FROM tb_resume WHERE resume_id = #{resumeId}
    </delete>
    
    <!-- 根据ID查询简历 -->
    <select id="findResumeById" parameterType="java.lang.Integer" resultMap="resumeResultMap">
        SELECT * FROM tb_resume WHERE resume_id = #{resumeId}
    </select>
    
    <!-- 查询用户的所有简历 -->
    <select id="findResumesByUserId" parameterType="java.lang.Long" resultMap="resumeResultMap">
        SELECT * FROM tb_resume WHERE user_id = #{userId} ORDER BY is_default DESC, update_time DESC
    </select>
    
    <!-- 查询用户的默认简历 -->
    <select id="findDefaultResumeByUserId" parameterType="java.lang.Long" resultMap="resumeResultMap">
        SELECT * FROM tb_resume WHERE user_id = #{userId} AND is_default = 1 LIMIT 1
    </select>
    
    <!-- 保存简历详细内容 -->
    <insert id="saveResumeDetail" parameterType="com.gr.geias.model.ResumeDetail" useGeneratedKeys="true" keyProperty="detailId">
        INSERT INTO tb_resume_detail(resume_id, basic_info, education, work_experience, project_experience, skills, certificates, self_evaluation, attachment_url)
        VALUES(#{resumeId}, #{basicInfo}, #{education}, #{workExperience}, #{projectExperience}, #{skills}, #{certificates}, #{selfEvaluation}, #{attachmentUrl})
    </insert>
    
    <!-- 更新简历详细内容 -->
    <update id="updateResumeDetail" parameterType="com.gr.geias.model.ResumeDetail">
        UPDATE tb_resume_detail
        SET basic_info = #{basicInfo},
            education = #{education},
            work_experience = #{workExperience},
            project_experience = #{projectExperience},
            skills = #{skills},
            certificates = #{certificates},
            self_evaluation = #{selfEvaluation},
            attachment_url = #{attachmentUrl}
        WHERE resume_id = #{resumeId}
    </update>
    
    <!-- 根据简历ID查询详细内容 -->
    <select id="findResumeDetailByResumeId" parameterType="java.lang.Integer" resultMap="resumeDetailResultMap">
        SELECT * FROM tb_resume_detail WHERE resume_id = #{resumeId}
    </select>
    
    <!-- 取消用户所有简历的默认状态 -->
    <update id="clearDefaultStatus" parameterType="java.lang.Long">
        UPDATE tb_resume SET is_default = 0 WHERE user_id = #{userId}
    </update>
    
    <!-- 设置简历为默认简历 -->
    <update id="setDefaultResume" parameterType="java.lang.Integer">
        UPDATE tb_resume SET is_default = 1 WHERE resume_id = #{resumeId}
    </update>
</mapper> 